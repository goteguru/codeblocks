<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini project: AutoCAD 2024 + Google Sheets (Apps Script Web App) - Drawing from the cloud</title>

  <!-- (Optional) If you used in previous lessons -->
  <!-- <link rel="stylesheet" href="codeblock.css"> -->

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111824;
      --text:#e6edf3;
      --muted:#9fb0c0;
      --border:#213042;
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --warn:#fbbf24;
      --bad:#fb7185;
      --ok:#34d399;
      --codebg:#0a1220;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7fafc;
        --panel:#ffffff;
        --text:#0b1220;
        --muted:#4b5563;
        --border:#e5e7eb;
        --accent:#0284c7;
        --accent2:#059669;
        --warn:#b45309;
        --bad:#be123c;
        --ok:#047857;
        --codebg:#0b1220;
      }
    }
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
    }
    header{
      padding:28px 18px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(125,211,252,0.08), transparent);
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 0 18px 48px; }
    h1{ margin:0 0 10px; font-size: 28px; line-height: 1.2; }
    .sub{ color:var(--muted); margin:0; }
    nav{
      margin:18px 0 0;
      display:flex; flex-wrap:wrap; gap:10px;
    }
    nav a{
      color:var(--text);
      text-decoration:none;
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,0.02);
    }
    nav a:hover{ border-color: var(--accent); }
    section{
      margin-top: 26px;
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 18px 18px 16px;
    }
    h2{ margin: 0 0 10px; font-size: 20px; }
    h3{ margin: 16px 0 8px; font-size: 16px; }
    p{ margin: 10px 0; }
    ul,ol{ margin: 10px 0 10px 22px; }
    .badge{
      display:inline-block; font-size:12px; padding:2px 8px;
      border:1px solid var(--border); border-radius: 999px; color: var(--muted);
      margin-left: 8px;
    }
    .callout{
      border-left: 4px solid var(--accent);
      padding: 10px 12px;
      background: rgba(125,211,252,0.06);
      border-radius: 10px;
      margin: 12px 0;
    }
    .warn{
      border-left-color: var(--warn);
      background: rgba(251,191,36,0.08);
    }
    .ok{
      border-left-color: var(--ok);
      background: rgba(52,211,153,0.08);
    }
    .bad{
      border-left-color: var(--bad);
      background: rgba(251,113,133,0.08);
    }
    code, pre{
      font-family: var(--mono);
      font-size: 13px;
    }
    pre{
      background: var(--codebg);
      color: #e6edf3;
      padding: 12px;
      border-radius: 12px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .k{
      color: var(--accent);
      font-weight: 600;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
    }
    details{
      margin: 10px 0;
      border:1px dashed rgba(159,176,192,0.35);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.02);
    }
    summary{
      cursor:pointer;
      color: var(--muted);
      font-weight: 600;
    }
    .todo{
      display:inline-block;
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--accent2);
      margin-left: 8px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--border);
      margin: 10px 0;
    }
    th,td{
      text-align:left;
      padding:10px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      font-size: 14px;
    }
    th{ color: var(--muted); font-weight: 600; }
    tr:last-child td{ border-bottom:0; }
    footer{
      color: var(--muted);
      padding: 18px;
      text-align:center;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/darcula.css" />
  <link rel="stylesheet" href="codeblocks.css" />
</head>

<body>
  <header>
    <div class="wrap">
      <h1>Mini project: AutoCAD 2024 + Google Sheets: Drawing from the cloud</h1>
	<p>
	By the end of the course, let's look at something more serious, a real integration project! 
	Let's connect AutoCAD with Google Sheets,
	and create an AutoCAD command that can draw based on a cloud-based
	spreadsheet (for example, rectangles, but of course it could draw anything).
	We want to implement it so that if the spreadsheet changes, it redraws.
	</p>
	<p>
	If you can't complete this project (or don't want to install AutoCAD),
	don't be discouraged, because this is a relatively complex system,
	using many components. Do half of it (creating the web service) and just read the rest
	and try to understand the code.
	(Of course - as always - you can ask an LLM for help to get past the point where you get stuck).
	</p>

      <nav>
        <a href="#celt">Goals and overview</a>
        <a href="#terv">Technology plan</a>
        <a href="#sheets">Sheets setup</a>
        <a href="#appsscript">Apps Script + Deploy</a>
        <a href="#teszt">Endpoint test</a>
        <a href="#autocad">AutoCAD JS + WEBLOAD</a>
        <a href="#hibak">Troubleshooting</a>
        <a href="#feladatok">Extra tasks</a>
      </nav>
    </div>
  </header>

  <div class="wrap">

    <section id="celt">
      <h2>Goals</h2>

      <p>
        In this lesson, we want to show how flexibly (and in many places) we can use
	JavaScript (ECMAScript) when <strong>connecting systems</strong>!
	In this project, specifically, we will connect AutoCAD to Google Sheets, but you could attach many other systems
	to many other services. Let's see what we want:
      </p>

      <ul>
        <li>Google Sheets stores the drawing parameters,</li>
        <li>a <strong>Apps Script Web App</strong> reads and returns data as JSON,</li>
        <li>AutoCAD 2024 loads a JavaScript add-on that downloads the data and <strong>draws rectangles</strong> (it could draw other things too, if you prefer).</li>
      </ul>

      <div class="callout ok">
        <strong>Authentication will be simplified here:</strong> the Web App will run in "Anyone with the link" mode, so anyone can access it.
	To prevent everyone from accessing our data (the valuable boxes :)), 
        we introduce a <strong>shared secret</strong> (a large random code <code>?key=VALUE</code>) that must be sent by the client.
	If not sent, no data is returned.
      </div>

      <h3>To do this, we need to create:</h3>
      <ul>
        <li>a Google Sheet template with data,</li>
        <li>an Apps Script endpoint that accesses the spreadsheet: <code>GET /exec?key=...</code> → <code>{ items: [...] }</code>,</li>
        <li>an AutoCAD command: <strong>drawFromCloud</strong>, which uses the endpoint and draws rectangles.</li>
      </ul>
    </section>

    <section id="terv">
      <h2>Technology plan</h2>

      <div class="grid2">
        <div>
          <h3>Data flow</h3>
          <pre>
AutoCAD 2024 (JavaScript)
   |
   |  HTTPS GET  /exec?key=SECRET
   v
Apps Script Web App
   |
   |  SpreadsheetApp → Google Sheets
   v
JSON response: { items: [ {x,y,width,height}, ... ] }
   |
   v
AutoCAD: Run RECTANG commands
          </pre>
        </div>

        <div>
          <h3>Why do it this way?</h3>
	  <p>Could it be done differently? Yes. A thousand ways. We could implement serious OAuth2 authentication,
	  refresh tokens (much more complex), or work with local files (simpler). 
	  We chose this pattern because it is relatively simple, yet modern 
	  and efficient.
	  </p>
          <ul>
            <li><strong>Small</strong>: no OAuth2 setup, no token refresh.</li>
            <li><strong>Professional</strong>: web API → JSON → processing → automated drawing. (This is how the "big guys" do it)</li>
            <li><strong>Extendable</strong>: later, it can include 3D, block placement, attributes, layers, etc.</li>
          </ul>

        </div>
      </div>
    </section>

    <section id="sheets">
      <h2>Step 1 - Prepare Google Sheets <span class="todo">TODO</span></h2>

      <h3>1.1 Create the spreadsheet</h3>
      <ol>
        <li>Create a new Google Sheets document (e.g., named <strong>CloudRects</strong>).</li>
        <li>Rename the first sheet: <strong>Rects</strong> (this is where we will look for data).</li>
      </ol>

      <h3>1.2 Columns (headers)</h3>
      <p>In the first row of the <strong>Rects</strong> sheet, enter:</p>

      <pre>x	y	width	height</pre>
      <p class="ok">If you select all and paste with ctrl+shift+v instead of ctrl+v, it will not put everything into one cell but into separate cells, as it should!</p>

      <h3>1.3 Sample data</h3>
      <p>Copy and paste the following rows (below the header):</p>

      <pre>
0	0	100	50
120	0	60	60
0	80	200	30
220	80	40	120
      </pre>

      <details>
        <summary>Hint: what do these mean?</summary>
        <ul>
          <li><code>x, y</code>: coordinates of the bottom-left corner</li>
          <li><code>width, height</code>: dimensions of the rectangle</li>
          <li>The coordinates are in AutoCAD's current units.</li>
        </ul>
      </details>
    </section>

    <section id="appsscript">
      <h2>Steps 2-3 - Apps Script endpoint + deploy <span class="todo">TODO</span></h2>

      <h3>2.1 Create Apps Script project</h3>
      <ol>
        <li>In Sheets: <strong>Extensions</strong> → <strong>Apps Script</strong>.</li>
        <li>Name the project, e.g., <strong>cloud-rects-api</strong>.</li>
      </ol>

      <h3>2.2 Set shared secret</h3>
      <p>
        In this example, we will use a simple shared secret.
        Choose any value, e.g.:
      </p>
      <pre>AZ_EN_szuperTitk0s-kood0m-998834</pre>
      <p>
      Your AutoCAD script will also know this code (you will write it the same way)
      and send it to the Apps Script. If someone doesn't know this code, the Apps Script
      will not communicate with them. This way (more or less) we prevent unauthorized access
      to our valuable rectangle data!
      </p>

      <div class="callout warn">
        <strong>Important:</strong> in a real industrial system, this is not very strong security.
        If you have truly valuable data, you should implement proper OAuth2 authentication.
        Here, it would be too complicated, so we stick to this simple method. If needed, you can look into it later.
      </div>

      <h3>2.3 Apps Script code (doGet → JSON)</h3>
      <p>
        Copy and paste the following code into <code>Code.gs</code>. 
        The editor should be opened the same way as in the previous project: Extensions → Apps Script.
        You must change these two fields:
        <strong>SPREADSHEET_ID</strong> and <strong>SHARED_SECRET</strong>.
      </p>
      <details>
        <summary>Hint: How do I find my SPREADSHEET_ID?</summary>
	<p>Every Google document has an identifier code (looks like a random string). 
	If you open the spreadsheet, you can see it in the URL bar: it's the part between /d/ and /edit.
	This code uniquely identifies your document, and the script will use it to know which document to access among your many documents!</p>
	<p>For example, if you see this in the URL:</p>
<pre>
https://docs.google.com/spreadsheets/d/1AbCDefGhIJkLMnopQRstuVWxyz1234567890abcdEFg/edit#gid=0
</pre>
Your document ID is: 1AbCDefGhIJkLMnopQRstuVWxyz1234567890abcdEFg
      </details>

      <textarea data-lang="js" data-readonly>
const SPREADSHEET_ID = "YOUR_SHEETS_ID_HERE";
const SHEET_NAME = "Rects"; // this is the sheet name
const SHARED_SECRET = "MY_SHARED_SECRET";

function doGet(e) {
  // check secret key
  const key = (e && e.parameter && e.parameter.key) ? String(e.parameter.key) : "";
  if (key !== SHARED_SECRET) {
    return ContentService
      .createTextOutput(JSON.stringify({ error: "Unauthorized" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // read spreadsheet
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = ss.getSheetByName(SHEET_NAME);
  // if sheet not found: error
  if (!sh) {
    return ContentService
      .createTextOutput(JSON.stringify({ error: "Sheet not found: " + SHEET_NAME }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const values = sh.getDataRange().getValues(); // header + rows
  if (!values || values.length < 2) {
    return ContentService
      .createTextOutput(JSON.stringify({ items: [] }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const header = values[0].map(h => String(h).trim());
  const rows = values
    .slice(1)
    .filter(r => r.some(cell => cell !== "" && cell != null));

  // convert rows to objects
  const items = rows.map(r => {
    const obj = {};
    header.forEach((h, i) => obj[h] = r[i]);
    return obj;
  });

  // send response:
  return ContentService
    .createTextOutput(JSON.stringify({ items }))
    .setMimeType(ContentService.MimeType.JSON);
}
      </textarea>

      <h3>Step 3 - Deploy as web app</h3>
      <ol>
        <li>Apps Script: <strong>Deploy (publish)</strong> button at the top right</li>
        <li>Select type: <strong>Web app</strong></li>
        <li>Description: whatever you like, e.g., AutoCAD integration</li>
        <li>Execute as: <strong>Me</strong></li>
        <li>Who has access: <strong>Anyone with the link</strong></li>
        <li>Click Deploy and accept permissions</li>
      </ol>

      <div class="callout ok">
        At the end of deployment, you'll get a URL, e.g.:<br/>
        <code>https://script.google.com/macros/s/AKfycb.../exec</code>
	<p>Save this somewhere, because the AutoCAD script will use it.</p>
      </div>
    </section>

    <section id="teszt">
      <h2>Step 4 - Test endpoint from browser <span class="todo">TODO</span></h2>

      <h3>4.1 Call</h3>
      <p>
        Copy the URL you received into the browser's address bar and press Enter.
	You should see: {"error":"Unauthorized"} (since we didn't provide the key).
	This message is generated by our program.
      </p>
      <h3>4.2 Call with key</h3>
      <p>
      Append to the URL (after /exec): <code>?key=MY_SHARED_SECRET</code>. 
      Use your own secret, not MY_SHARED_SECRET.
      </p>
      <pre>.../exec?key=MY_SHARED_SECRET</pre>

      <p>If everything is correct, you should see something like:</p>
      <pre>{
  "items": [
    {"x":0,"y":0,"width":100,"height":50},
    {"x":120,"y":0,"width":60,"height":60},
    ...
  ]
}</pre>

      <details>
        <summary>Common issues</summary>
        <ul>
          <li><strong>Incorrect URL:</strong> not calling the <code>/exec</code> endpoint.</li>
          <li><strong>SPREADSHEET_ID error:</strong> spreadsheet not found. You pasted the ID incorrectly.</li>
          <li><strong>Sheet name error:</strong> sheet name is not "Rects".</li>
        </ul>
      </details>
    </section>

    <section id="autocad">
      <h2>Steps 5-6 - AutoCAD 2024 script + WEBLOAD <span class="todo">TODO</span></h2>

      <h3>5.1 Create AutoCAD JS file</h3>
      <p>
        Create a file on your machine, e.g.: <code>C:\autocad-cloud\drawFromCloud.js</code>
	(Preferably avoid very long paths, as this is what you'll load from)
      </p>

      <p>
        Copy the code below into it, and modify:
        <strong>WEB_APP_URL</strong> and <strong>SECRET</strong>.
      </p>

      <textarea data-lang="js" data-readonly>
(function () {
  // 1) Configuration
  const WEB_APP_URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";
  const SECRET = "MY_SHARED_SECRET_2026";

  function toNumber(v, def = 0) {
    const n = Number(v);
    return Number.isFinite(n) ? n : def;
  }

  async function fetchItems() {
    const url = WEB_APP_URL + "?key=" + encodeURIComponent(SECRET);

    // In AutoCAD embedded web runtime environment, fetch is usually available.
    // If not, you can use XHR (see Hint).
    const res = await fetch(url, { method: "GET" });

    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();

    if (json.error) throw new Error(json.error);
    if (!Array.isArray(json.items)) return [];

    return json.items.map(it => ({
      x: toNumber(it.x),
      y: toNumber(it.y),
      w: toNumber(it.width),
      h: toNumber(it.height),
    }));
  }

  function drawRect(x, y, w, h) {
    // AutoCAD command: RECTANG
    const p1 = `${x},${y}`;
    const p2 = `${x + w},${y + h}`;
    Acad.Editor.executeCommand("_.RECTANG", p1, p2);
  }

  async function drawFromCloud() {
    try {
      const items = await fetchItems();

      if (!items.length) {
        Acad.Editor.executeCommand("_.PROMPT", "\"No items.\"");
        return;
      }

      for (const r of items) {
        if (r.w <= 0 || r.h <= 0) continue;
        drawRect(r.x, r.y, r.w, r.h);
      }

      Acad.Editor.executeCommand("_.PROMPT", `"OK: drew ${items.length} rectangles."`);
    } catch (err) {
      Acad.Editor.executeCommand("_.PROMPT", `"Error: ${String(err.message || err)}"`);
    }
  }

  // 2) Register command in AutoCAD
  Acad.Editor.addCommand(
    "CLOUDTOOLS",        // group
    "drawFromCloud",     // global name
    "drawFromCloud",     // local name (this will be the command you type in command line)
    Acad.CommandFlag.TRANSPARENT,
    drawFromCloud
  );
})();
      </textarea>

      <h3>6.1 Load into AutoCAD</h3>
      <p>Great. Now we just need to tell AutoCAD to find the script in this file!</p>
      <ol>
        <li>Open AutoCAD, start a new drawing.</li>
        <li>Command line: <strong>WEBLOAD</strong></li>
        <li>Load (load) subcommand</li>
        <li>Select or type the URL path to <code>drawFromCloud.js</code>.</li>
      </ol>
      <p>This loads the JavaScript function that registered the command. From now on, it can be run as an AutoCAD command!</p>
      <details>
        <summary>What is "URL format"?</summary>
	<p>
	The URL format is how you access resources on the web, like a website. 
	It usually starts with https://... But you can also access your local files this way, starting with file:/// (three slashes).
	The rest is the file path, but you should use normal slashes, not backslashes (which are non-standard).
	</p>
	<p>
	So if you saved your file as
        <code>C:\autocad-cloud\drawFromCloud.js</code>
        the URL format would be:
        <code>file:///C:/autocad-cloud/drawFromCloud.js</code>.
	</p>
      </details>

      <h3>6.2 Run</h3>
      <p>Type in the command line:</p>
      <pre>drawFromCloud</pre>

      <div class="callout ok">
        If everything went well, the rectangles read from Sheets will appear in the drawing.
      </div>
    </section>

    <section id="hibak">
      <h2>Troubleshooting (quick diagnostics)</h2>

      <table>
        <thead>
          <tr>
            <th>Phenomenon</th>
            <th>Cause</th>
            <th>Quick fix</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>In AutoCAD: <code>Error: Unauthorized</code></td>
            <td>Wrong <code>SECRET</code> or missing <code>key</code></td>
            <td>Check SECRET in JS and Web App URL; test from browser too.</td>
          </tr>
          <tr>
            <td>Nothing draws, "No items."</td>
            <td>Empty/wrong sheet, header error</td>
            <td>Header exactly: <code>x y width height</code>; at least 1 data row.</td>
          </tr>
          <tr>
            <td>HTTP 404 / 500</td>
            <td>Wrong deploy URL, permissions not granted</td>
            <td>Deploy - web app - new URL; approve permissions.</td>
          </tr>
        </tbody>
      </table>

      <details>
        <summary>Hint: if it still doesn't work and you want to do "debug" messages</summary>
        <p>
          Use <code>Acad.Editor.executeCommand("_.PROMPT", "...")</code> messages in your program.
	  (Unluckily, console.log doesn't work here, because we want to see errors in AutoCAD.)
          For example, print the URL, number of items, first record, etc.
        </p>
      </details>
    </section>

    <section id="feladatok">
      <h2>Extra challenges (optional)</h2>

      <ol>
        <li>
          <strong>Layer management:</strong> add a <code>layer</code> column in Sheets, and set the layer before drawing.
        </li>
        <li>
          <strong>Validation:</strong> the Web App filters out invalid rows (negative width/height), and returns a <code>warnings</code> list.
        </li>
        <li>
          <strong>Spreadsheet update:</strong> after drawing in AutoCAD, the Web App writes back a "lastDrawnAt" timestamp at the end of the row.
        </li>
        <li>
          <strong>Shape extension:</strong> instead of rectangles, support <code>POLYLINE</code> or circle (x,y,r) parameters. Or specify the type in a column.
        </li>
      </ol>

      <div class="callout">
        <strong>Lesson learned:</strong> Drawing isn't the main point (although visual), but the ability of JavaScript to download <em>data</em> from the cloud and automatically execute a desktop operation.
      </div>
    </section>

  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
<script src="codeblocks.js"></script>
</body>
</html>